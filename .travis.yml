services:
  - mysql
  - redis-server
  - memcached

language: ruby

sudo: false

script: ./test/script/ci.sh

before_install:
  - 'mkdir -p /home/travis/gemfiles && touch /home/travis/gemfiles/IGNORE.txt && cp -R /home/travis/gemfiles/* .'
  - 'if [[ `ruby --version` =~ ^ruby\ 1\. ]]; then gem update --system 1.8.25; fi'
  - gem --version
  # currently there's an incompatibility between Bundler 1.13 with JRuby 1.7, see Bundler issue #4975
  - 'if [[ `ruby --version` =~ ^jruby\ 1\. ]]; then rvm use @global && gem uninstall -x bundler && gem install bundler -v 1.12.5; else gem install bundler; fi'
  - bundle --version

install: bundle install --local --path=/home/travis/bundle || bundle --path=/home/travis/bundle

# Travis default Mongo is currently 2.4.14, which has some instrumentation differences with >= 2.6.
before_script:
  - 'if [[ $GROUP == "database" ]]; then ./test/script/install_mongodb.sh; fi'

before_cache:
  - rsync -a --prune-empty-dirs --include '*/' --include 'Gemfile.*' --exclude '*' . /home/travis/gemfiles

cache:
  directories:
    - /home/travis/bundle
    - /home/travis/gemfiles

branches:
  only:
    - master
    - dev
    - release

notifications:
  webhooks: http://notifitron.herokuapp.com/
  on_success: always
  on_failure: always

rvm:
  - 2.3.1

env:
  global:
    - CI_BUNDLE_PATH=/home/travis/bundle
    - BUNDLE_PATH=/home/travis/bundle
    - MONGODB=2.6.11
    - JAVA_OPTS="-XX:+TieredCompilation -XX:TieredStopAtLevel=1 -Xmx640m"
    - JRUBY_OPTS="-Xcompile.invokedynamic=false -J-Djruby.compile.mode=OFF"
    - RBXOPT="-Xcompiler.no_rbc -Xint"
    - SERIALIZE=1
    - TESTOPTS="-v"
    - VERBOSE = 1
  matrix:
    - TYPE=FUNCTIONAL GROUP=background

matrix:
  fast_finish: true
